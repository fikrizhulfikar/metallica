<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org" xmlns="http://www.w3.org/1999/xhtml"
      xmlns:sec="http://www.thymeleaf.org/thymeleaf-extras-springsecurity4">
<head>
    <meta charset="utf-8"/>
    <meta http-equiv="X-UA-Compatible" content="IE=edge"/>
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"/>
    <meta name="description" content="UI - For calculte valas"/>
    <meta name="author" content="ICON PLN"/>
    <meta name="keyword" content="Valas Administrator"/>
    <link rel="shortcut icon" href="/static/new-backend/img/icon.png"/>

    <title>Valas Administrator</title>

    <!-- Icons -->
    <link href="/static/css/jquery-ui.css" rel="stylesheet"/>
    <link href="/static/new-backend/css/font-awesome.min.css" rel="stylesheet"/>
    <link href="/static/new-backend/css/simple-line-icons.css" rel="stylesheet"/>

    <!-- Main styles for this application -->
    <link href="/static/new-backend/css/style.css" rel="stylesheet"/>
    <link href="/static/css/backend/jquery.dataTables.min.css" rel="stylesheet"/>
    <link href="/static/css/select2.css" rel="stylesheet"/>
    <link href="/static/js/jquery-toast-plugin-1.3.2/dist/jquery.toast.min.css" rel="stylesheet"/>
    <style>
        td.details-control {
            background: url('/static/images/details_open.png') no-repeat center center;
            cursor: pointer;
        }

        tr.shown td.details-control {
            background: url('/static/images/details_close.png') no-repeat center center;
        }

        div.dataTables_wrapper div.dataTables_paginate {
            float: left !important;
            text-align: left !important;
        }

        .dataTables_length {
            padding-left: -10px !important;
        }

        .panel-custom {
            overflow-x: scroll;
            padding: 10px 0px 10px 0px !important;
        }

        .dataTables_wrapper {
            padding: 0px !important;
        }

        .color-active {
            color: darkslategray;
        }

        .datatables_action {
            text-align: right;
        }

        .datatables_action-center {
            text-align: center;
        }
        .th-middle{
            vertical-align: middle !important;
            text-align: center !important;
        }
        #loader {
            border: 16px solid #f3f3f3;
            border-radius: 50%;
            border-top: 16px solid #3498db;
            width: 120px;
            height: 120px;
            -webkit-animation: spin 2s linear infinite;
            animation: spin 2s linear infinite;
            margin-top: 22.5%;
        }

        @-webkit-keyframes spin {
            0% { -webkit-transform: rotate(0deg); }
            100% { -webkit-transform: rotate(360deg); }
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
    <div th:replace="${view} :: stylesheets-backend"></div>



</head>
<body class="app header-fixed sidebar-fixed aside-menu-fixed aside-menu-hidden">
<div style="display: none" class="col-md-12" id="loader-div" align="center"><div id="loader"></div></div>
<header th:replace="operator/shared/new-header :: header-param" class="app-header navbar">
</header>

<div class="app-body">
    <div class="sidebar" th:replace="operator/shared/new-menu :: menu-param">
    </div>

    <main th:replace="${view} :: content" class="main">
    </main>

</div>
<footer class="app-footer" style="cursor: default">
    <a><b>L'Metallica</b></a> Â© 2017 Administrator.
    <span class="float-right">Powered by <b><a>ICON </a></b>
        </span>
</footer>
</body>
<!-- Bootstrap and necessary plugins -->
<script src="/static/new-backend/bower_components/jquery/dist/jquery.min.js"></script>
<script src="/static/js/select2.min.js"></script>
<script src="/static/new-backend/bower_components/tether/dist/js/tether.min.js"></script>
<script src="/static/new-backend/bower_components/bootstrap/dist/js/bootstrap.min.js"></script>
<script src="/static/js/backend/jquery.dataTables.min.js"></script>
<script src="/static/js/backend/dataTables.bootstrap4.min.js"></script>
<script src="/static/new-backend/bower_components/pace/pace.min.js"></script>
<script src="/static/js/sockjs.min.js"></script>
<script src="/static/js/stomp.min.js"></script>


<!-- GenesisUI main scripts -->
<script src="/static/new-backend/js/app.js"></script>
<script src="/static/js/jquery-ui.js"></script>
<script src="/static/js/show-dialog.js"></script>
<script src="/static/js/maskedinput/jquery.maskmoney.js"></script>
<script src="/static/js/maskedinput/jquery.mask.min.js"></script>
<script src="/static/js/maskedinput/FormatMoney.js"></script>
<script src="/static/js/pdfmake/pdfmake.min.js"></script>
<script src="/static/js/pdfmake/vfs_fonts.js"></script>
<script src="/static/js/backend/coreapps.js"></script>
<script src="/static/js/accounting.min.js"></script>

<script src="/static/js/firebase/firebase.js"></script>
<script src="/static/js/firebase/firebase-app.js"></script>
<script src="/static/js/firebase/firebase-auth.js"></script>
<script src="/static/js/firebase/firebase-database.js"></script>
<script src="/static/js/firebase/firebase-firestore.js"></script>
<script src="/static/js/firebase/firebase-messaging.js"></script>

<script src="/static/js/jquery-toast-plugin-1.3.2/dist/jquery.toast.min.js"></script>

<div th:replace="${view} :: scripts-backend"></div>
<script th:inline="javascript">
    var roleUser = [[${#authentication.getAuthorities().toString()}]]
    var username = [[${#authentication.getPrincipal().getUsername().toString()}]]
    var thp1 = roleUser.replace("[", "")
    var thp2 = thp1.replace("]", "")
    var newRoleUser = thp2.split(", ");
    console.log("role : ",newRoleUser)
    console.log("username : ",username)

    // get notification

    $.ajax({
        type: "GET",
        url: baseUrl + "notification/get",
        async: true,
        success: function(obj) {
            var prop;
            var count = 0;
            var drop_down =
                '<div id="notification_div" class="dropdown-menu dropdown-menu-right dropdown-menu-lg show" style="width:750px !important;" >\n' +
                '  <div class="dropdown-header text-center">\n' +
                '   <strong id="notification_count_title"></strong>\n' +
                '  </div>\n' +
                '</div>\n';
            $("#notification_li").append(drop_down);
            for(prop in obj) {
                console.log(obj[prop]);
                if(!obj.hasOwnProperty(prop)) continue;
                var added =
                    '<a href="#" class="dropdown-item">\n' +
                    '  <div class="message">\n' +
                    '    <div>\n' +
                    '      <small class="text-muted" id="notification_title">'+obj[prop].title+'</small>\n' +
                    '      <small class="text-muted float-right mt-1" id="notification_date">'+new Date(obj[prop].date)+'</small>\n' +
                    '    </div>\n' +
                    '    <div class="small text-muted text-truncate" id="notification_body">'+obj[prop].body+'</div>\n' +
                    '  </div>\n' +
                    '</a>';
                count += 1;
                $("#notification_div").append(added);
            }
            $("#notification_count").html(count);
            $("#notification_count_title").html('You have ' + count + ' unread message.');
        }
    });

    /*connect();

    function connect() {
        sockJsProtocols = ["xhr-streaming", "xhr-polling"];
        var socket = new SockJS("http://localhost:9212/liquiditas", null, {transports: sockJsProtocols});
        stompClient = Stomp.over(socket);
        stompClient.connect({}, function(frame) {
            console.log('Status connected : ' + frame);
            stompClient.subscribe('/pusher/invoice/info', function(message) {
                showMessageOutput(message);
            });
        },function(msg) {
            console.log("err msg : ",msg)
            $("#sts-con").hide();
            $("#sts-discon").show();
        });
    }

    function disconnect() {
        if(stompClient != null) {
            stompClient.disconnect();
            console.log("Disconnected");
        }

    }

    function showMessageOutput(message) {
        console.log(message);
    }

    //for send message to socket server
    function sendContent() {
        stompClient.send("/push/content", {}, "test send from client");
    }

    */

    // Initialize Firebase
    var config = {
        apiKey: "AIzaSyA9kqEMrDaFznAi-tWRxaxZHXZwOkd6HjY",
        authDomain: "fir-lmetalica.firebaseapp.com",
        databaseURL: "https://fir-lmetalica.firebaseio.com",
        projectId: "fir-lmetalica",
        storageBucket: "",
        messagingSenderId: "190551123521"
    };

    firebase.initializeApp(config);

    // [START get_messaging_object]
    // Retrieve Firebase Messaging object.
    const messaging = firebase.messaging();

    // [END get_messaging_object]

    // IDs of divs that display Instance ID token UI or request permission UI.
    const tokenDivId = 'token_div';
    const permissionDivId = 'permission_div';

    // [START refresh_token]
    // Callback fired if Instance ID token is updated.
    messaging.onTokenRefresh(function () {
        messaging.getToken()
            .then(function (refreshedToken) {
                console.log('Token refreshed: ' + refreshedToken);
                // Indicate that the new Instance ID token has not yet been sent to the
                // app server.
                setTokenSentToServer(false);
                // Send Instance ID token to app server.
                sendTokenToServer(refreshedToken);
                // [START_EXCLUDE]
                // Display new Instance ID token and clear UI of all previous messages.
                resetUI();
                // [END_EXCLUDE]
            })
            .catch(function (err) {
                console.log('Unable to retrieve refreshed token ', err);
                // showToken('Unable to retrieve refreshed token ', err);
            });
    });
    // [END refresh_token]

    // [START receive_message]
    // Handle incoming messages. Called when:
    // - a message is received while the app has focus
    // - the user clicks on an app notification created by a sevice worker
    //   `messaging.setBackgroundMessageHandler` handler.

    // [END re`ceive_message]

    function resetUI() {
        // clearMessages();
        // showToken('loading...');
        // [START get_token]
        // Get Instance ID token. Initially this makes a network call, once retrieved
        // subsequent calls to getToken will return from cache.
        messaging.getToken()
            .then(function (currentToken) {
                if (currentToken) {
                    console.log("Current token: " + currentToken);
                    // subscribeTokenToTopic(currentToken, "lmetalica_topic");
                    setTokenSentToServer(false);
                    sendTokenToServer(currentToken);
                    // updateUIForPushEnabled(currentToken);
                } else {
                    // Show permission request.
                    console.log('No Instance ID token available. Request permission to generate one.');
                    // Show permission UI.
                    // updateUIForPushPermissionRequired();
                    setTokenSentToServer(false);
                }
            })
            .catch(function (err) {
                console.log('An error occurred while retrieving token. ', err);
                // showToken('Error retrieving Instance ID token. ', err);
                setTokenSentToServer(false);
            });
    }

    // [END get_token]

    function showToken(currentToken) {
        // Show token in console and UI.
        var tokenElement = document.querySelector('#token');
        tokenElement.textContent = currentToken;
    }

    // Send the Instance ID token your application server, so that it can:
    // - send messages back to this app
    // - subscribe/unsubscribe the token from topics
    function sendTokenToServer(currentToken) {
        if (!isTokenSentToServer()) {
            subscribeTokenToTopic(currentToken);
            console.log('Sending token to server...');
            // TODO(developer): Send the current token to your server.
            setTokenSentToServer(true);
        } else {
            console.log('Token already sent to server so won\'t send it again ' +
                'unless it changes');
        }

    }

    function isTokenSentToServer() {
        return window.localStorage.getItem('sentToServer') == 1;
    }

    function setTokenSentToServer(sent) {
        window.localStorage.setItem('sentToServer', sent ? 1 : 0);
    }

    function showHideDiv(divId, show) {
        const div = document.querySelector('#' + divId);
        if (show) {
            div.style = "display: visible";
        } else {
            div.style = "display: none";
        }
    }

    function requestPermission() {
        console.log('Requesting permission...');
        // [START request_permission]
        messaging.requestPermission()
            .then(function () {
                console.log('Notification permission granted.');
                // TODO(developer): Retrieve an Instance ID token for use with FCM.
                // [START_EXCLUDE]
                // In many cases once an app has been granted notification permission, it
                // should update its UI reflecting this.
                resetUI();
                // [END_EXCLUDE]
            })
            .catch(function (err) {
                console.log('Unable to get permission to notify.', err);
            });
        // [END request_permission]
    }

    function deleteToken() {
        // Delete Instance ID token.
        // [START delete_token]
        messaging.getToken()
            .then(function (currentToken) {
                messaging.deleteToken(currentToken)
                    .then(function () {
                        console.log('Token deleted.');
                        setTokenSentToServer(false);
                        // [START_EXCLUDE]
                        // Once token is deleted update UI.
                        resetUI();
                        // [END_EXCLUDE]
                    })
                    .catch(function (err) {
                        console.log('Unable to delete token. ', err);
                    });
                // [END delete_token]
            })
            .catch(function (err) {
                console.log('Error retrieving Instance ID token. ', err);
                // showToken('Error retrieving Instance ID token. ', err);
            });

    }

    // Add a message to the messages element.
    function appendMessage(payload) {
        const messagesElement = document.querySelector('#messages');
        const dataHeaderELement = document.createElement('h5');
        const dataElement = document.createElement('pre');
        dataElement.style = 'overflow-x:hidden;'
        dataHeaderELement.textContent = 'Received message:';
        dataElement.textContent = JSON.stringify(payload, null, 2);
        messagesElement.appendChild(dataHeaderELement);
        messagesElement.appendChild(dataElement);
    }

    // Clear the messages element of all children.
    function clearMessages() {
        const messagesElement = document.querySelector('#messages');
        while (messagesElement.hasChildNodes()) {
            messagesElement.removeChild(messagesElement.lastChild);
        }
    }

    function updateUIForPushEnabled(currentToken) {
        showHideDiv(tokenDivId, true);
        showHideDiv(permissionDivId, false);
        // showToken(currentToken);
    }

    function updateUIForPushPermissionRequired() {
        showHideDiv(tokenDivId, false);
        showHideDiv(permissionDivId, true);
    }

    function subscribeTokenToTopic(token) {
        $.ajax({
            type: "POST",
            beforeSend: function(request) {
                request.setRequestHeader("Authority", token);
                request.setRequestHeader("Content-Type", "application/x-www-form-urlencoded");
            },
            url: baseUrl + "notification/subscribe",
            data: {
                token: token
            },
            success: function(msg) {
                console.log("Subscribe success. " + msg)
            }
        });

    }

    messaging.onMessage(function (payload) {
        console.log("Message received. ", payload);
        $.toast({
            text : payload.notification.body,
            hideAfter : 5000,              // `false` to make it sticky or time in miliseconds to hide after
            textAlign : 'left',            // Alignment of text i.e. left, right, center
            position : 'bottom-right'       // bottom-left or bottom-right or bottom-center or top-left or top-right or top-center or mid-center or an object representing the left, right, top, bottom values to position the toast on page
        })
        // [START_EXCLUDE]
        // Update the UI to include the received message.
        // appendMessage(payload);
        // [END_EXCLUDE]
    });

    resetUI();
    requestPermission();

    function readNotification(key) {
        $.ajax({
            type: "POST",
            url: baseUrl + "notification/read/" + key,
            async: true,
            contentType: 'application/x-www-form-urlencoded',
            success: function(obj) {

            }
        });
    }

    function formatDate(longDate) {
        var monthNames = [
            "Januari", "Februari", "Maret",
            "April", "Mei", "Juni", "Juli",
            "Agustus", "September", "Oktober",
            "November", "Desember"
        ];

        var date = new Date(longDate);
        var now = new Date();

        if ((data.getDate() - 1) === now) {
            
        }

        var day = date.getDate();
        var monthIndex = date.getMonth();
        var year = date.getFullYear();

        return day + ' ' + monthNames[monthIndex] + ' ' + year;
    }

</script>
</html>